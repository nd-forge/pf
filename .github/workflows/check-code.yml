name: Check Code

on:
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.23', '1.24', '1.25']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Run tests
        run: go test -v -race -count=1 ./...

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.64.8
          install-mode: goinstall

  coverage:
    needs: [test]
    runs-on: ubuntu-latest
    outputs:
      total: ${{ steps.check.outputs.total }}
      below_threshold: ${{ steps.check.outputs.below_threshold }}
      report: ${{ steps.check.outputs.report }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Generate coverage
        run: go test -coverprofile=coverage.out -covermode=atomic ./...

      - name: Check coverage threshold
        id: check
        run: |
          REPORT=$(go tool cover -func=coverage.out)
          TOTAL=$(echo "$REPORT" | grep total | awk '{print $3}' | sed 's/%//')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if (( $(echo "$TOTAL < 80.0" | bc -l) )); then
            echo "below_threshold=true" >> $GITHUB_OUTPUT
          else
            echo "below_threshold=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          token: ${{ secrets.CODECOV_TOKEN }}

  fix-coverage:
    needs: [coverage]
    if: needs.coverage.outputs.below_threshold == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Fix coverage with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: "claude-opus-4-6"
          allowed_tools: "Edit,Read,Write,Glob,Grep,WebFetch,WebSearch,Bash(poetry update:*),Bash(poetry run pip-audit:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*)"
          prompt: |
            The current code coverage is ${{ needs.coverage.outputs.total }}%, which is below the 80% target.

            Analyze the coverage report below and add tests or improve the implementation to bring coverage above 80%.

            Coverage report:
            ${{ needs.coverage.outputs.report }}

            Requirements:
            - Identify functions and lines with insufficient coverage, then add tests for them
            - Follow the existing test patterns and style in pf_test.go
            - Verify all tests pass with `go test -race -count=1 ./...`
            - Run `go test -coverprofile=coverage.out -covermode=atomic ./...` and confirm coverage is above 80%
          claude_args: "--max-turns 30"
